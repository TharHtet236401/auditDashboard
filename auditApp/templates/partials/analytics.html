<!-- Chart Container -->
<div class="row mb-4">
    <div class="col">
        <h2 class="page-header">
            <i class="fas fa-chart-line me-2"></i>Analytics
        </h2>
        <p class="text-muted mb-0">
            Transaction Status Distribution
        </p>
    </div>
    <div class="col-auto">
        <a hx-get="{% url 'home' %}"
           hx-target="#transaction-container"
           hx-swap="innerHTML"
           class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Transactions
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-body chart-container">
                <canvas id="statusPieChart"></canvas>
                <!-- Data container -->
                <script id="chart-data" type="application/json">
                    {{ status_data|safe }}
                </script>
            </div>
        </div>
    </div>
</div>

<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
    canvas {
        max-height: 400px;
    }
    .card {
        margin-top: 2rem;
    }
</style>

<!-- Load Chart.js from CDN with onload handler -->
<script>
    // Function to load Chart.js dynamically
    function loadChartJs() {
        return new Promise((resolve, reject) => {
            if (window.Chart) {
                resolve(window.Chart);
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
            script.onload = () => resolve(window.Chart);
            script.onerror = () => reject(new Error('Failed to load Chart.js'));
            document.head.appendChild(script);
        });
    }

    // Function to get chart data
    function getChartData() {
        const dataScript = document.getElementById('chart-data');
        try {
            return JSON.parse(dataScript.textContent);
        } catch (error) {
            console.error('Error parsing chart data:', error);
            return null;
        }
    }

    // Function to create the chart
    function createAnalyticsChart() {
        // Get the canvas element
        const ctx = document.getElementById('statusPieChart');
        if (!ctx) {
            console.error('Canvas element not found');
            return;
        }

        // Get the chart data
        const chartData = getChartData();
        if (!chartData) {
            console.error('No valid chart data available');
            return;
        }

        console.log('Creating chart with data:', chartData);

        // Define colors for different statuses
        const backgroundColors = {
            'Approved': 'rgba(34, 197, 94, 0.8)',  // Green
            'Pending': 'rgba(234, 179, 8, 0.8)',   // Yellow
            'Rejected': 'rgba(239, 68, 68, 0.8)'   // Red
        };
        
        const borderColors = {
            'Approved': 'rgb(22, 163, 74)',
            'Pending': 'rgb(202, 138, 4)',
            'Rejected': 'rgb(220, 38, 38)'
        };

        // Prepare chart data
        const labels = Object.keys(chartData);
        const values = Object.values(chartData);
        const backgroundColor = labels.map(label => backgroundColors[label] || '#6B7280');
        const borderColor = labels.map(label => borderColors[label] || '#374151');

        // Create the chart
        return new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: { size: 14 }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Transaction Status Distribution',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 30
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Function to handle chart initialization/reinitialization
    async function initializeChart() {
        try {
            // Ensure Chart.js is loaded
            await loadChartJs();
            
            // Destroy existing chart if it exists
            const existingChart = Chart.getChart('statusPieChart');
            if (existingChart) {
                existingChart.destroy();
            }

            // Create new chart
            createAnalyticsChart();
        } catch (error) {
            console.error('Error initializing chart:', error);
        }
    }

    // Initialize chart when the content loads
    document.addEventListener('htmx:afterOnLoad', initializeChart);
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.querySelector('#statusPieChart')) {
            console.log('Content swapped, reinitializing chart...');
            initializeChart();
        }
    });

    // Also initialize on regular page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeChart);
    } else {
        initializeChart();
        // setTimeout(() => {
        //     alert("this is from anlytics.html")
        // }, 3000);
    }
</script>
  

  
